<project name="W3LS (Mellon/Moria)"
         default="all:redeploy"
         basedir=".">

  <property file="${user.home}/build.properties"/>
  <property file="build.properties"/>

  <taskdef name="deploy"
           classname="org.apache.catalina.ant.DeployTask"
           classpath="${jwsdp_home}/server/lib/catalina-ant.jar"/>
  <taskdef name="undeploy"
           classname="org.apache.catalina.ant.UndeployTask"
           classpath="${jwsdp_home}/server/lib/catalina-ant.jar"/>



  <target name="all:prepare"
          description="Prepares Mellon/Moria target directories">
    <mkdir dir="build.moria/WEB-INF/classes"/>
    <mkdir dir="build.mellon/WEB-INF/classes"/>
    <mkdir dir="dist"/>
    <mkdir dir="build.moria/WEB-INF/classes/templates"/>
    <copy todir="build.moria/WEB-INF/classes/templates">
      <fileset dir="moria/templates">
	<include name="**/*.vtl"/>
      </fileset>
    </copy>  
    <copy todir="build.moria/WEB-INF/classes">
      <fileset dir="moria/templates">
	<include name="**/*.properties"/>
      </fileset>
    </copy>  
    <copy file="moria/config/jaxrpc-ri.xml" todir="build.moria/WEB-INF"/>
    <copy file="moria/config/web.xml"       todir="build.moria/WEB-INF"/>
    <copy file="mellon/config/web.xml"      todir="build.mellon/WEB-INF"/>
    <copy file="moria/config/preferences_dev.xml" tofile="build.moria/WEB-INF/classes/Moria.xml"/>
    <copy file="mellon/config/preferences_dev.xml" tofile="build.mellon/WEB-INF/classes/Mellon.xml"/>
    <copy todir="build.moria/WEB-INF/lib">
      <fileset dir="moria/lib/">
	<include name="**/*.jar"/>
      </fileset>
      <fileset dir="lib/">
	<include name="**/*.jar"/>
      </fileset>
    </copy>  
    <copy todir="build.mellon/WEB-INF/lib">
      <fileset dir="mellon/lib/">
	<include name="**/*.jar"/>
      </fileset>
      <fileset dir="lib/">
	<include name="**/*.jar"/>
      </fileset>
    </copy>  
  </target>

  <target name="all:clean"
          description="Cleans Mellon/Moria target directories">
    <delete dir="build.moria"/>
    <delete dir="build.mellon"/>
    <delete dir="build.mellon-test"/>
    <delete dir="dist"/>
    <delete file="FeideAuthentication.wsdl"/>
  </target>

  <target name="moria:prepare:prod"
          description="Copy Moria's preferences.xml to target directory"
	  depends="all:prepare">
	  <delete file="build.moria/WEB-INF/classes/Moria.xml"/>
	  <copy file="moria/config/preferences.xml" tofile="build.moria/WEB-INF/classes/Moria.xml"/>
  </target>

  <target name="mellon:prepare:prod"
          description="Copy Mellon's preferences.xml to target directory"
	  depends="all:prepare">
	  <delete file="build.mellon/WEB-INF/classes/Mellon.xml"/>
	  <copy file="mellon/config/preferences.xml" tofile="build.mellon/WEB-INF/classes/Mellon.xml"/>
  </target>

  <target name="all:redeploy"
          description="Build and redeploy Mellon/Moria"
          depends="moria:redeploy,mellon:redeploy"/>



  <target name="moria:compile"
          description="Compile Moria source"
          depends="all:prepare">
    <javac srcdir="src"
           destdir="build.moria/WEB-INF/classes"
           includes="no/feide/moria/**">
	   <classpath>
                <fileset dir="lib/">
                  <include name="*.jar"/>
                </fileset>
                <fileset dir="moria/lib/">
                  <include name="*.jar"/>
                </fileset>
	   </classpath>
    </javac>

  </target>

  <target name="moria:create-war"
          description="Create Moria WAR file"
          depends="moria:compile">
    <delete file="dist/feide-moria-ws.war"/>
    <jar jarfile="dist/feide-moria-ws.war">
      <fileset dir="build.moria">
        <include name="WEB-INF/**"/>
        <include name="templates/**"/>
      </fileset>
    </jar>
  </target>

  <target name="moria:process-war"
          description="Process Moria WAR file with wsdeploy"
	  depends="moria:create-war">
    <delete file="dist/tmp-feide-moria.war"/>
    <exec executable="${jaxrpc_home}/bin/wsdeploy.sh">
      <arg line="-o"/>
      <arg line="dist/feide-moria.war"/>
      <arg line="dist/feide-moria-ws.war"/>
      <arg line="-verbose"/>
    </exec>
  </target>

  <target name="moria:export-wsdl"
          description="Export wsdl-file from war."
	  depends="moria:process-war">
    <mkdir dir="dist/tmp"/>
    <exec executable="jar" dir="dist/tmp">
      <arg line="-xf ../feide-moria.war WEB-INF/FeideAuthentication.wsdl"/>
    </exec>
    <exec executable="sed" output="FeideAuthentication.wsdl">
      <arg line="'s!REPLACE_WITH_ACTUAL_URL!${wsdl_url}!' dist/tmp/WEB-INF/FeideAuthentication.wsdl"/>
    </exec>
    <delete dir="dist/tmp"/>
  </target>

  <target name="moria:deploy"
          description="Deploy Moria to Tomcat"
	  depends="moria:export-wsdl">
    <deploy url="${jwsdp_manager_url}"
            username="${jwsdp_manager_username}"
            password="${jwsdp_manager_password}"
            path="/feide-moria"
            war="file:dist/feide-moria.war"/>
  </target>

  <target name="moria:undeploy"
          description="Undeploy Moria from Tomcat">
     <undeploy url="${jwsdp_manager_url}"
              username="${jwsdp_manager_username}"
              password="${jwsdp_manager_password}"
              path="/feide-moria"/>
  </target>


  <target name="moria:redeploy"
          description="Build and redeploy Moria"
          depends="moria:undeploy,moria:deploy"/>

  <target name="moria:prod"
          description="Build and assemble war file for production"
          depends="all:prepare,moria:prepare:prod,moria:process-war">
  </target>


  <target name="mellon:generate-stubs"
          description="Generate Mellon-side stubs from WSDL"
          depends="all:prepare">
    <exec executable="${jaxrpc_home}/bin/wscompile.sh">
      <arg line="-gen:client"/>
      <arg line="-d build.mellon/WEB-INF/classes"/>
      <arg line="mellon/config/jaxrpc.xml"/>
    </exec>
  </target>

  <target name="mellon:compile"
          description="Compile Mellon source"
          depends="mellon:generate-stubs">
    <javac srcdir="src"
           destdir="build.mellon/WEB-INF/classes"
           includes="no/feide/mellon/**"
           excludes="no/feide/mellon/test/*">
	   <classpath>
                <fileset dir="lib/">
                  <include name="*.jar"/>
                </fileset>
                <fileset dir="mellon/lib/">
                  <include name="*.jar"/>
                </fileset>
	   </classpath>
    </javac>
  </target>

  <target name="mellon:create-war"
          description="Create Mellon WAR file"
          depends="mellon:compile">
    <delete file="dist/feide-mellon.war"/>
    <jar jarfile="dist/feide-mellon.war">
      <fileset dir="build.mellon" includes="WEB-INF/**"/>
    </jar>
  </target>

  <target name="mellon:deploy"
          description="Deploy Mellon to Tomcat"
	  depends="mellon:create-war">
    <deploy url="${jwsdp_manager_url}"
            username="${jwsdp_manager_username}"
            password="${jwsdp_manager_password}"
            path="/feide-mellon"
            war="file:dist/feide-mellon.war"/>
  </target>

  <target name="mellon:undeploy"
          description="Undeploy Mellon from Tomcat">
     <undeploy url="${jwsdp_manager_url}"
              username="${jwsdp_manager_username}"
              password="${jwsdp_manager_password}"
              path="/feide-mellon"/>
  </target>

  <target name="mellon:redeploy"
          description="Build and redeploy Mellon"
          depends="mellon:undeploy,mellon:deploy"/>

  <target name="mellon:prod"
          description="Build and assemble war file for production"
          depends="all:prepare,mellon:prepare:prod,mellon:create-war">
  </target>

  <!-- Old Mellon JAX-RPC test -->
  <target name="mellon-test:prepare"
          description="Prepare Mellon test target directory">
    <mkdir dir="build.mellon-test"/>
    <mkdir dir="dist"/>
  </target>

  <target name="mellon-test:generate-stubs"
          description="Generate Mellon test client stubs"
          depends="mellon-test:prepare">
    <exec executable="${jaxrpc_home}/bin/wscompile.sh">
      <arg line="-gen:client"/>
      <arg line="-d build.mellon-test"/>
      <arg line="mellon/config/jaxrpc.xml"/>
    </exec>
  </target>

  <target name="mellon-test:compile"
          description="Compile Mellon test"
          depends="mellon-test:prepare">
    <javac srcdir="src"
           destdir="build.mellon-test"
           classpath="${jwsdp_jars}"
           includes="no/feide/mellon/test/**">
      <classpath>
        <fileset dir="lib/">
          <include name="*.jar"/>
        </fileset>
        <fileset dir="mellon/lib/">
          <include name="*.jar"/>
        </fileset>
      </classpath>
    </javac>
  </target>

  <target name="mellon-test:jar"
          description="Create Mellon test JAR file"
          depends="mellon-test:prepare">
    <delete file="build.mellon-test/AuthenticationServiceClient.jar"/>
    <jar destfile="build.mellon-test/AuthenticationServiceClient.jar"
         basedir="build.mellon-test"
         includes="no/feide/mellon/test/* no/feide/moria/service/*"/>
  </target>

  <target name="mellon-test:build"
          description="Build Mellon test"
          depends="mellon-test:generate-stubs,mellon-test:compile,mellon-test:jar"/>

  <target name="mellon-test:run"
          description="Run Mellon test">
    <java fork="on" 
          classname="no.feide.mellon.test.AuthenticationServiceClient">
      <classpath>
        <fileset dir="build.mellon-test/">
          <include name="*.jar"/>
        </fileset>
        <fileset dir="lib/">
          <include name="*.jar"/>
        </fileset>
        <fileset dir="mellon/lib/">
          <include name="*.jar"/>
        </fileset>
      </classpath>
    </java>
  </target> 

</project>
